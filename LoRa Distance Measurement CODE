#include <SPI.h>
#include <LoRa.h>

#define NSS 5
#define RST 14
#define DIO0 26
#define LED_PIN 2

void setup() {
  Serial.begin(115200);
  pinMode(LED_PIN, OUTPUT);

  LoRa.setPins(NSS, RST, DIO0);

  if (!LoRa.begin(433E6)) {
    Serial.println("LoRa init failed");
    while (1);
  }

  Serial.println("LoRa Receiver Ready");
}

void loop() {
  int packetSize = LoRa.parsePacket();
  if (packetSize) {

    String msg = "";
    while (LoRa.available()) {
      msg += (char)LoRa.read();
    }

    int rssi = LoRa.packetRssi();
    float snr = LoRa.packetSnr();

    // Distance estimation (meters)
    // TxPower ≈ -59 dBm, path loss exponent n ≈ 2.7
    float distance = pow(10, ((-59 - rssi) / (10 * 2.7)));

    Serial.print("Message: ");
    Serial.print(msg);
    Serial.print(" | RSSI: ");
    Serial.print(rssi);
    Serial.print(" dBm | SNR: ");
    Serial.print(snr);
    Serial.print(" dB | Distance: ");
    Serial.print(distance);
    Serial.println(" m");

    digitalWrite(LED_PIN, HIGH);
    delay(100);
    digitalWrite(LED_PIN, LOW);
  }
}
